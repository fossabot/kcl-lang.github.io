<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KCL programming language. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KCL programming language. Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="KCL programming language." href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">One post tagged with &quot;Performance&quot; | KCL programming language.</title><meta data-rh="true" property="og:title" content="One post tagged with &quot;Performance&quot; | KCL programming language."><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kcl-lang.github.io/blog/tags/performance"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/kcl-logo.jpg"><link data-rh="true" rel="canonical" href="https://kcl-lang.github.io/blog/tags/performance"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/blog/tags/performance" hreflang="en"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/zh-CN/blog/tags/performance" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/blog/tags/performance" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RE5E6BQUZV-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f544af73.css">
<link rel="preload" href="/assets/js/runtime~main.a901e07f.js" as="script">
<link rel="preload" href="/assets/js/main.21077f32.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" role="banner"><div class="announcementBarPlaceholder_NC_W"></div><div class="announcementBarContent_KsVm">⭐️ If you like KCL, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/KusionStack/KCLVM">Github</a></div><button type="button" class="clean-btn close announcementBarClose_FG1z" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/kcl-logo.jpg" alt="KCL Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/kcl-logo.jpg" alt="KCL Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title"></b></a><a class="navbar__item navbar__link" docid="intro/kcl-intro" href="/docs/user_docs/getting-started/">Get Started</a><a class="navbar__item navbar__link" href="/docs/reference/lang/tour">Reference</a><a class="navbar__item navbar__link" href="/docs/tools/cli/">Tools</a><a href="http://39.106.40.108/-/play/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" sidebarid="playground"><span>Playground<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/KusionStack/examples" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" sidebarid="examples"><span>Examples<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/docs/community/intro/">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/events/2022/kcl_paper">Events</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/events/2022/kcl_paper">0.4.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/events/2022/kcl_paper">Next</a></li><li><a class="dropdown__link" href="/docs/events/2022/kcl_paper">0.4.4</a></li><li><a class="dropdown__link" href="/docs/0.4.3/events/2022/kcl_paper">0.4.3</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/performance" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/zh-CN/blog/tags/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">中文（中国）</a></li><li><a href="https://github.com/KusionStack/kcl-lang.io/issues/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="searchBox_kyqE"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022-kcl-osdt-meeting">KCL Introduction on OSDT 2022 Meeting</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022-kcl-0.4.4-release-blog">KCL v0.4.4 Release Blog</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022-kcl-rewrite-with-rust">40x Faster! We rewrote our project with Rust</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022-kcl-setta-meeting">KCL Introduction on SETTA 2022 Meeting</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022-declarative-config-overview">The Landscape of Declarative Configuration</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;Performance&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/2022-kcl-rewrite-with-rust">40x Faster! We rewrote our project with Rust</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-11-29T00:00:00.000Z" itemprop="datePublished">November 29, 2022</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Pengfei, Xu</span></div><small class="avatar__subtitle" itemprop="description">KCL Team Member</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>Rust has quietly become one of the most popular programming languages. As an emerging system language, Rust has many characteristics, such as the memory security mechanism, performance advantages close to C/C++, excellent developer community, experience of documents, tool chains and IDEs. This blog will introduce the process of using Rust to rewrite the project and gradually implementing the production environment, as well as the reasons for choosing Rust in the rewrite process, the problems encountered, and the results of using Rust to rewrite.</p><p>The project we are using Rust to develop is called <a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">KCL</a>. (KCL) is an open source constraint-based record and functional language. KCL improves the writing of a large number of complex configurations through mature programming language technology and practice, and is committed to building better modularity, scalability and stability around configuration, simpler logic writing, fast automation and good ecological extensionality. For more specific KCL usage scenarios, please visit the <a href="https://kcl-lang.github.io/" target="_blank" rel="noopener noreferrer">KCL website</a>. This blog will not repeat them too much.</p><p>KCL was written in Python before. Considering the user experience, performance and stability, we have decided to rewrite it in Rust, and the following benefits were obtained:</p><ul><li>Fewer bugs due to Rust&#x27;s powerful compilation check and error handling.</li><li>66% improvement in language end-to-end compilation and execution performance.</li><li>The performance of the language front-end parser has been improved by 20 times.</li><li>The performance of the language semantic analyzer has been improved by 40 times.</li><li>The average memory usage of the language compiler during compilation is half of the original Python version.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-problems-have-we-encountered">What problems have we encountered<a class="hash-link" href="#what-problems-have-we-encountered" title="Direct link to heading">​</a></h2><p>The compiler, build system or runtime uses Rust to do similar things in technology like projects of the same type in the community <a href="https://github.com/denoland/deno" target="_blank" rel="noopener noreferrer">deno</a>, <a href="https://github.com/swc-project/swc" target="_blank" rel="noopener noreferrer">swc</a>, <a href="https://github.com/vercel/turbo" target="_blank" rel="noopener noreferrer">turbopack</a>, <a href="https://github.com/rust-lang/rust" target="_blank" rel="noopener noreferrer">rustc</a>. We used Rust to completely build the front, middle and runtime of the compiler, and achieved some results, but we did not do this about a year ago.</p><p>A year ago, we used Python to build the whole implementation of KCL compiler. Although it ran well at the beginning, Python was easy to use, rich in ecology, and the team&#x27;s research and development efficiency was also very high, with the expansion of the code and the increase of the number of engineers, code maintenance became more difficult.</p><p>Although we forced to write Python type annotations in the project and adopted stricter lint tools. Besides, the coverage of code test lines has also reached more than 90%, but there are still many runtime errors, such as Python None empty objects, attributes not found, and so on. We need to be careful when refactoring Python code, which seriously affects the user experience.</p><p>In addition, when KCL users are the majority of developers, any errors in the programming language or compiler internal implementation are intolerable, which also brings a series of problems to our user experience. Programs written in Python start slowly, and their performance cannot meet the efficiency demands of online compilation and execution of the automation system, because in our scenario, After users modify KCL code, they need to be able to quickly display the compilation results. Obviously, the compiler written in Python cannot meet the use requirements well.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-use-rust">Why use Rust<a class="hash-link" href="#why-use-rust" title="Direct link to heading">​</a></h2><p>We chose Rust for the following reasons:</p><ul><li>We used Python, Go and Rust to implement a simple programming language stack virtual machine and made a performance comparison. In this scenario, Go and Rust have similar performance, Python has a large performance gap, and Rust is adopted under comprehensive consideration. The details of the stack virtual machine code implemented by the three languages are here: <a href="https://github.com/Peefy/StackMachine" target="_blank" rel="noopener noreferrer">https://github.com/Peefy/StackMachine</a>.</li><li>More and more compilers or runtimes of programming languages, especially front-end infrastructure projects, are written or refactored using Rust. In addition, Rust has appeared in infrastructure, database, search engine, network, cloud native, UI, embedded and other fields. At least, the feasibility and stability of the implementation of programming languages have been verified.</li><li>Considering that the subsequent project development will involve the direction of blockchain and smart contract, and a large number of blockchain and smart contract projects in the community are written by Rust.</li><li>Better performance and stability can be achieved through Rust, making the system easier to maintain and more robust. At the same time, C APIs can be exposed through FFI for multilingual use and expansion, facilitating ecological expansion and integration.</li><li>Rust supports WASM in a friendly way. A large number of WASM ecosystems in the community are built by Rust. KCL languages and compilers can be compiled into WASM with the help of Rust and run in browsers.</li></ul><p>Based on the above reasons, we chose Rust instead of Go. In the whole rewriting process, we found that Rust&#x27;s comprehensive quality is really excellent (high performance and enough abstraction). Although there is some cost in some language features, especially the lifetime, it is not rich in ecology.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-are-the-difficulties-in-using-rust">What are the difficulties in using Rust<a class="hash-link" href="#what-are-the-difficulties-in-using-rust" title="Direct link to heading">​</a></h2><p>Although we decided to rewrite the entire KCL project with Rust, most team members have no experience in writing a certain project with Rust, and I has only learned <a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">The Rust Programming Language</a>. I vaguely remember that I gave up when I learned about intelligent pointers such as <code>Rc</code> and <code>RefCell</code>. At that time, I didn&#x27;t expect that there would be anything similar to C++ in Rust.</p><p>The risk of using Rust is mainly the cost of Rust language learning, which is indeed mentioned in various Rust blogs. Because the overall architecture of the KCL project has not changed much, and some module design and code writing have been optimized for Rust, so the entire rewrite is carried out in the process of learning while practicing. When we first started to use Rust to write the whole project, we still spent a lot of time on knowledge query, compilation and debugging. However, as the project progressed, the difficulties we encountered in our experience when using Rust were mainly mental transformation and development efficiency.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="mental-transformation">Mental transformation<a class="hash-link" href="#mental-transformation" title="Direct link to heading">​</a></h3><p>First of all, the syntax and semantics of Rust well absorb and integrate the concepts related to the type system in functional programming, such as the Abstract Algebraic Type (ADT). In addition, there is no concept related to &quot;inheritance&quot; in Rust. If you can&#x27;t understand it well, even ordinary structure definitions in other languages may take a lot of time in Rust. For example, the following Python code may be defined like this in Rust</p><ul><li>Python</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> dataclasses </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> dataclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLObject</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@dataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLIntObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KCLObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@dataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLFloatObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KCLObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>Rust</li></ul><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enum KCLObject {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Int(u64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Float(f64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Of course, more time is spent fighting against the error reports of the Rust compiler itself. The Rust compiler will often cause developers to &quot;run into a wall&quot;, such as borrowing check errors. Especially for the KCL compiler, its core structure is the Abstract Syntax Tree (AST), which is a recursive and nested tree structure.</p><p>It is sometimes difficult to give consideration to the relationship between variable variability and borrowing check in Rust, Just like the scope structure <code>Scope</code> defined in KCL compiler, for scenarios with circular references, it is used to display the interdependence of data that needs to be aware of, while making extensive use of intelligent pointer structures commonly used in Rust such as <code>Rc</code>, <code>RefCell</code> and <code>Weak</code>.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/// A Scope maintains a set of objects and links to its containing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// (parent) and contained (children) scopes. Objects may be inserted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// and looked up by name. The zero value for Scope is a ready-to-use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// empty scope.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct Scope {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The parent scope.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub parent: Option&lt;Weak&lt;RefCell&lt;Scope&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The child scope list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub children: Vec&lt;Rc&lt;RefCell&lt;Scope&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope object mapping with its name.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub elems: IndexMap&lt;String, Rc&lt;RefCell&lt;ScopeObject&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope start position.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub start: Position,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope end position.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub end: Position,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope kind.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub kind: ScopeKind,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="development-efficiency">Development efficiency<a class="hash-link" href="#development-efficiency" title="Direct link to heading">​</a></h3><p>The development efficiency of Rust can be described as &quot;restraining first and then improving&quot;. At the beginning of the handwritten project, if the team members have not been exposed to the concept of functional programming and related programming habits, the development speed will be significantly slower than Python, Go, Java and other languages. However, once they become familiar with the common methods and best practices of the Rust standard library, as well as the common error modification of the Rust compiler, the development efficiency will be greatly improved, and they can write high-quality, safe and efficient code natively.</p><p>For example, I have encountered a Rust lifetime error as shown in the following code. After a long time of troubleshooting, it was found that the lifetime mismatch was caused by forgetting to label lifetime parameters. In addition, the lifetime of Rust is coupled with concepts such as type system, scope, ownership, and borrowing check, resulting in a high cost and complexity of understanding, and error reporting information is often not as obvious as type errors. The lifetime mismatch error reporting information is sometimes slightly inflexible, which may lead to a high cost of troubleshooting. Of course, the efficiency will be improved after more familiar with relevant concepts.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">struct Data&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b: &amp;&#x27;a u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// func2 omit lifecycle parameters, and func2 does not.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The lifecycle of func2 will be deduced as &#x27;_ by the Rust compiler by default,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// which may lead to lifetime mismatch error.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;&#x27;a&gt; Data&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn func1(&amp;self) -&gt; Data&lt;&#x27;a&gt; {Data { b: &amp;0 }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn func2(&amp;self) -&gt; Data {Data { b: &amp;0 }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="rewrite-revenue-ratio-using-rust">Rewrite revenue ratio using Rust<a class="hash-link" href="#rewrite-revenue-ratio-using-rust" title="Direct link to heading">​</a></h2><p>After several members of the team spent several months using Rust to completely rewrite and stably put it into the production environment for several months, we reviewed the whole process and felt that it was very rewarding.</p><p>From a technical perspective, the rewrite process not only trained to quickly learn a new programming language and programming knowledge, but also put them into practice, And the whole rewrite process made us reflect on the unreasonable design of the KCL compiler and modify it. For a programming language, this is a long cycle project. What we learned is that the compiler system is more stable, safe, with clear code, fewer bugs, and better performance.</p><p>Although not all modules get 40 times the performance (because the performance bottleneck of some modules, such as the KCL runtime, is the memory deep copy operation), but I personally think it is still worthwhile. And when Rust has been used for a certain period of time, mind and development efficiency are no longer limiting factors.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>I personally think that the most important thing after using Rust to rewrite the project is whether I have learned a new programming language or whether Rust is very popular and we have written many fancy codes using Rust. It really makes the KCL language and compiler more stable, and the startup speed and automation efficiency are no longer troubled. The performance of KCL is better than that of other programming languages in the same type of fields in the community, so that users of our language and tools can experience the improvement. These are all due to Rust&#x27;s no-GC, high-performance, better error handling, memory management, zero abstraction and other features. In short, as users, they are the biggest beneficiaries.</p><p>Finally, if you like the KCL project, or want to use KCL for your own scenarios, or want to use Rust to participate in an open source project, welcome to visit <a href="https://github.com/KusionStack/community" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/community</a> to join our community to participate in discussion and co construction 👏👏👏。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="reference">Reference<a class="hash-link" href="#reference" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM</a></li><li><a href="https://github.com/Peefy/StackMachine" target="_blank" rel="noopener noreferrer">https://github.com/Peefy/StackMachine</a></li><li><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">https://doc.rust-lang.org/book/</a></li><li><a href="https://github.com/sunface/rust-course" target="_blank" rel="noopener noreferrer">https://github.com/sunface/rust-course</a></li><li><a href="https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/" target="_blank" rel="noopener noreferrer">https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kcl">KCL</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/rust">Rust</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/performance">Performance</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/programming-language">Programming Language</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/compiler">Compiler</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 40x Faster! We rewrote our project with Rust" href="/blog/2022-kcl-rewrite-with-rust"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Document</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/user_docs/getting-started/intro">Introduction</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resource</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://join.slack.com/t/KusionStack/shared_invite/zt-19lqcc3a9-_kTNwagaT5qwBE~my5Lnxg" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.antgroup.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/img/oss_logo.svg" alt="AntGroup Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo" width="160" height="51"><img src="/img/oss_logo.svg" alt="AntGroup Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo" width="160" height="51"></a></div><div class="footer__copyright">Copyright © 2022 KCL Authors</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a901e07f.js"></script>
<script src="/assets/js/main.21077f32.js"></script>
</body>
</html>