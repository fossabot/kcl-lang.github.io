<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Abstraction  Validation  Production-Ready Blog</title>
        <link>https://kcl-lang.github.io/zh-CN/blog</link>
        <description>Abstraction  Validation  Production-Ready Blog</description>
        <lastBuildDate>Sat, 10 Dec 2022 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[OSDT 2022 会议 KCL 介绍内容]]></title>
            <link>https://kcl-lang.github.io/zh-CN/blog/2022-kcl-osdt-meeting</link>
            <guid>2022-kcl-osdt-meeting</guid>
            <pubDate>Sat, 10 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[PDF 下载]]></description>
            <content:encoded><![CDATA[<p><a href="https://kcl-lang.github.io/talks/kcl-osdt2022.pdf" target="_blank" rel="noopener noreferrer">PDF 下载</a></p>]]></content:encoded>
            <category>KCL</category>
            <category>Configuration</category>
            <category>Policy</category>
        </item>
        <item>
            <title><![CDATA[KCL v0.4.4 发布日志]]></title>
            <link>https://kcl-lang.github.io/zh-CN/blog/2022-kcl-0.4.4-release-blog</link>
            <guid>2022-kcl-0.4.4-release-blog</guid>
            <pubDate>Tue, 06 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[KCL 团队很高兴地宣布 0.4.4 版本现在已经可用！本次发布主要为 KCL 语言增加了自定义 YAML Manifests 输出的能力，用户可以通过编写代码并调用系统函数来自定义 YAML 输出的样式而无需理解复杂的 schema settings 语义；此外本次发布提供了最新的 KCL Python SDK 可用于 Python 用户对 KCL 直接集成；同时我们大大降低了 KCL 安装包的体积，平均安装包体积降低为之前版本的五分之一，并包含多项编译器报错信息优化和 bug 修复。您可以在 KCL 发布页面 获得更多详细发布信息和 KCL 二进制下载链接。]]></description>
            <content:encoded><![CDATA[<p>KCL 团队很高兴地宣布 0.4.4 版本现在已经可用！本次发布主要为 KCL 语言增加了自定义 YAML Manifests 输出的能力，用户可以通过编写代码并调用系统函数来自定义 YAML 输出的样式而无需理解复杂的 schema settings 语义；此外本次发布提供了最新的 <a href="https://github.com/KusionStack/kclvm-py" target="_blank" rel="noopener noreferrer">KCL Python SDK</a> 可用于 Python 用户对 KCL 直接集成；同时我们大大降低了 KCL 安装包的体积，平均安装包体积降低为之前版本的五分之一，并包含多项编译器报错信息优化和 bug 修复。您可以在 <a href="https://github.com/KusionStack/KCLVM/releases/tag/v0.4.4-alpha.2" target="_blank" rel="noopener noreferrer">KCL 发布页面</a> 获得更多详细发布信息和 KCL 二进制下载链接。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="背景">背景<a class="hash-link" href="#背景" title="Direct link to heading">​</a></h2><p>KCL 是一个开源的基于约束的记录及函数语言，期望通过成熟的编程语言技术和实践来改进对大量繁杂配置和策略的编写，致力于构建围绕配置的更好的模块化、扩展性和稳定性，更简单的逻辑编写，以及更快的自动化集成和良好的生态延展性。</p><p>本文将向读者介绍 KCL 社区的近期动态。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="新增特性">新增特性<a class="hash-link" href="#新增特性" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="自定义-yaml-格式输出">自定义 YAML 格式输出<a class="hash-link" href="#自定义-yaml-格式输出" title="Direct link to heading">​</a></h3><p>在过去的 KCL 版本中，YAML 输出的样式是在 KCL 编译器中是硬编码的，用户可以为 schema 的 <code>__settings__</code> 元属性设置为不同的值来决定 YAML 输出样式，这带来了较高的复杂度和记忆成本，因此在 0.4.4 版本中我们提供了一个系统库函数用于开发人员更简单地自定义 YAML 输出样式，这个函数的签名如下：</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">manifests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yaml_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sort_keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_private </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_none </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"---"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>这个函数的功能是将 KCL 对象列表序列化为带 <code>---</code> 分隔符的样式 YAML 输出，它具有两个参数:</p><ul><li><code>values</code> - 一个 KCL 对象列表</li><li><code>opts</code> - YAML 序列化选项<ul><li><code>sort_keys</code>：是否按属性名称的字典序对序列化结果进行排序（默认为 <code>False</code>）。</li><li><code>ignore_private</code>：是否忽略名称以 <code>_</code> 开头的属性序列化输出（默认为 <code>True</code>）。</li><li><code>ignore_none</code>：是否忽略值为 <code>None</code> 的属性（默认为 <code>False</code>）。</li><li><code>sep</code>：在多个 YAML 文档之间选择怎样的分隔符（默认为 <code>"---"</code>）。</li></ul></li></ul><p>下面我们通过一个例子来说明:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Deployment"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deploy"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        replica </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v1"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Service"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"svc"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Deployment </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Deployment </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Service </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">manifests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yaml_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deployments </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>首先我们通过 <code>import</code> 关键字导入 <code>manifests</code> 模块并定义 2 个 Deployment 以及 2 个 Service 资源，当我们想以 YAML stream 并以 <code>---</code> 作为分隔符的格式依次输出这 4 个资源时，我们可以将它们合并为一个 KCL 列表并作为 <code>manifests.yaml_stream</code> 函数的 <code>values</code> 形参进行传入 (如无特殊需求，opts 参数一般使用默认值即可)，最终得到 YAML 输出为:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replica</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replica</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>注：schema 的 <code>__settings__</code> 元属性设置 YAML 输出样式的特性仍然可以在 v0.4.4 版本中使用，大约后续两个小版本发布后在 KCL v0.4.6 版本中，我们会移除这个特性</p></blockquote><p>更多信息请参阅：<a href="https://github.com/KusionStack/KCLVM/issues/94" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM/issues/94</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="python-sdk">Python SDK<a class="hash-link" href="#python-sdk" title="Direct link to heading">​</a></h3><p>除了已有的 <a href="https://github.com/KusionStack/kclvm-go" target="_blank" rel="noopener noreferrer">KCL Go SDK</a>, 本次发布还新增了 KCL Python SDK，使用 Python SDK 要求您本地具备高于 3.7.3 的 Python 版本和 pip 包管理工具，可以通过如下命令进行安装并获得帮助信息</p><div class="codeBlockContainer_I0IT language-cmd theme-code-block"><div class="codeBlockContent_wNvx cmd"><pre tabindex="0" class="prism-code language-cmd codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 -m pip install kclvm &amp;&amp; python3 -m kclvm --help</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="命令行工具">命令行工具<a class="hash-link" href="#命令行工具" title="Direct link to heading">​</a></h4><p>编写名为 <code>main.k</code> 的 KCL 文件:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kcl"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">age </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Person</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kcl"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    age</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Person </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Person </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    age </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行如下命令并获得输出:</p><div class="codeBlockContainer_I0IT language-cmd theme-code-block"><div class="codeBlockContent_wNvx cmd"><pre tabindex="0" class="prism-code language-cmd codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 -m kclvm hello.k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">age: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age: 101</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="api">API<a class="hash-link" href="#api" title="Direct link to heading">​</a></h4><p>此外，我们还可以通过 Python 代码实现对 KCL 文件的执行</p><p>编写名为 <code>main.py</code> 的 python 文件:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> kclvm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">exec</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> kclvm_exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> kclvm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">planner </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> planner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">planner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kclvm_exec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"hello.k"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">filter_by_path_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行如下命令并获得输出:</p><div class="codeBlockContainer_I0IT language-cmd theme-code-block"><div class="codeBlockContent_wNvx cmd"><pre tabindex="0" class="prism-code language-cmd codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 main.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">age: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age: 101</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>可以看出通过命令行工具和 API 可以获得同样的输出。</p><p>目前 KCL Python SDK 还处于早期预览版本，后续 KCL 团队会持续更新并提供更丰富的功能，更多信息请参阅：<a href="https://github.com/KusionStack/kclvm-py" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/kclvm-py</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="安装体积优化">安装体积优化<a class="hash-link" href="#安装体积优化" title="Direct link to heading">​</a></h2><p>在新的 KCL 版本中，我们将 KCL 内置的 Python3 剥离，使得 KCL 二进制压缩包的体积从平均 200M 降低为 35M，用户可以更快地下载并使用 KCL，并且 Python Plugin 成为一个可选项，如果您想启用 KCL Python 插件，一个额外要求是需要您本地具备高于 3.7.3 版本的 Python 以及 pip 包管理工具，更多详情请参考 <a href="https://github.com/KusionStack/kcl-plugin" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/kcl-plugin</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="错误修复">错误修复<a class="hash-link" href="#错误修复" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="函数调用错误信息优化">函数调用错误信息优化<a class="hash-link" href="#函数调用错误信息优化" title="Direct link to heading">​</a></h3><p>在 0.4.4 版本中，KCL 优化了当函数参数个数不匹配时的错误信息输出，支持显示函数名称以及参数不匹配个数</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">schema Foo</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Error: "Foo" takes 1 positional argument but 3 were given</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Error: "f" takes 1 positional argument but 2 were given</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>更多信息请参阅：<a href="https://github.com/KusionStack/KCLVM/issues/299" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM/issues/299</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="插值三引号字符串格式化错误修复">插值三引号字符串格式化错误修复<a class="hash-link" href="#插值三引号字符串格式化错误修复" title="Direct link to heading">​</a></h3><p>在之前的 KCL 版本中，对如下代码进行格式化会错误将携带字符串插值的三引号格式化为单引号字符串并导致编译错误，在 0.4.4 版本中我们进行了修复</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Before KCL v0.4.4, variable "bar" will be formatted as:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># foo = 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># bar = "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ${foo}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">${foo}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>更多信息请参阅：<a href="https://github.com/KusionStack/KCLVM/issues/294" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM/issues/294</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="其他错误修复">其他错误修复<a class="hash-link" href="#其他错误修复" title="Direct link to heading">​</a></h3><p>更多错误修复详见：<a href="https://github.com/KusionStack/KCLVM/milestone/2?closed=1" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM/milestone/2?closed=1</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="文档">文档<a class="hash-link" href="#文档" title="Direct link to heading">​</a></h2><p><a href="https://kcl-lang.github.io/" target="_blank" rel="noopener noreferrer">KCL 网站</a> 初步建立，并完善 Kubernetes 场景<a href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/" target="_blank" rel="noopener noreferrer">相关文档</a>.</p><p>更多网站信息详见 <a href="https://kcl-lang.github.io/" target="_blank" rel="noopener noreferrer">https://kcl-lang.github.io/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="社区动态">社区动态<a class="hash-link" href="#社区动态" title="Direct link to heading">​</a></h2><p>KCL 社区新增三名外部贡献者 @my-vegetable-has-exploded, @possible-fqz, @orangebees, 感谢他们热情并积极地参与贡献</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="下一步计划">下一步计划<a class="hash-link" href="#下一步计划" title="Direct link to heading">​</a></h2><p>预计 2023 年 1 月底，我们将发布 KCL v0.4.5 版本，预期重点演进包括</p><ul><li>语言用户界面持续优化，体验持续提升和用户痛点解决</li><li>更多场景和生态如 Kubernetes 和 CI/CD Pipeline 场景 KCL 支持和文档更新</li><li>KCL Windows 版本支持</li><li>KCL 包管理工具 kpm 发布</li><li>KCL 新版 playground 支持</li></ul><p>更多详情请参考 <a href="https://github.com/KusionStack/KCLVM/milestone/3" target="_blank" rel="noopener noreferrer">KCL v0.4.5 Milestone</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="常见问题及解答">常见问题及解答<a class="hash-link" href="#常见问题及解答" title="Direct link to heading">​</a></h2><p>常见问题及解答详见：<a href="https://kcl-lang.github.io/docs/user_docs/support/" target="_blank" rel="noopener noreferrer">https://kcl-lang.github.io/docs/user_docs/support/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="其他资源">其他资源<a class="hash-link" href="#其他资源" title="Direct link to heading">​</a></h2><ul><li><a href="https://kcl-lang.github.io/" target="_blank" rel="noopener noreferrer">KCL 网站</a></li><li><a href="https://kusionstack.io/" target="_blank" rel="noopener noreferrer">Kusion 网站</a></li><li><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">KCL 仓库</a></li><li><a href="https://github.com/KusionStack/kusion" target="_blank" rel="noopener noreferrer">Kusion 仓库</a></li><li><a href="https://github.com/KusionStack/konfig" target="_blank" rel="noopener noreferrer">Konfig 仓库</a></li></ul><p>欢迎加入我们的社区进行交流 👏👏👏：<a href="https://github.com/KusionStack/community" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/community</a></p>]]></content:encoded>
            <category>Release Blog</category>
            <category>KCL</category>
            <category>KusionStack</category>
            <category>Kusion</category>
        </item>
        <item>
            <title><![CDATA[SETTA 2022 会议 KCL 介绍内容]]></title>
            <link>https://kcl-lang.github.io/zh-CN/blog/2022-kcl-setta-meeting</link>
            <guid>2022-kcl-setta-meeting</guid>
            <pubDate>Thu, 27 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[PDF 下载]]></description>
            <content:encoded><![CDATA[<p><a href="https://kcl-lang.github.io/talks/kcl-setta2022.pdf" target="_blank" rel="noopener noreferrer">PDF 下载</a></p>]]></content:encoded>
            <category>KCL</category>
            <category>Configuration</category>
        </item>
        <item>
            <title><![CDATA[The Landscape of Declarative Configuration]]></title>
            <link>https://kcl-lang.github.io/zh-CN/blog/2022-declarative-config-overview</link>
            <guid>2022-declarative-config-overview</guid>
            <pubDate>Thu, 15 Sep 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[零、前言]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="零前言">零、前言<a class="hash-link" href="#零前言" title="Direct link to heading">​</a></h2><p>文本仅用于澄清声明式配置技术概述，<a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">KCL</a> 概念以及核心设计，以及与其他配置语言的对比，更多 <a href="https://kusionstack.io/" target="_blank" rel="noopener noreferrer">KusionStack</a> 的概念、背景与设计、以及与其他开源技术栈的区别将不会在本文中讨论。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="一声明式配置概述">一、声明式配置概述<a class="hash-link" href="#一声明式配置概述" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="11-配置的重要性">1.1 配置的重要性<a class="hash-link" href="#11-配置的重要性" title="Direct link to heading">​</a></h3><ul><li>软件不是一成不变的，每天有成千上万的配置更新，并且配置本身也在逐渐演进，对规模化效率有较高的诉求<ul><li><strong>配置更新越来越频繁</strong>：而配置提供了一种改变系统功能的低开销方式，不断发展的业务需求、基础设施要求和其他因素意味着系统需要不断变化。</li><li><strong>配置规模越来越大</strong>：一份配置往往要分发到不同的云站点、不同的租户、不同的环境等。</li><li><strong>配置场景广泛</strong>：应用配置、数据库配置、网络配置、监控配置等。</li><li><strong>配置格式繁多</strong>：JSON, YAML, XML, TOML, 各种配置模版如 Java Velicity, Go Template 等。</li></ul></li><li>配置的稳定性至关重要，系统宕机或出错的一个最主要原因是有大量工程师进行频繁的实时配置更新，表 1 示出了几个由于配置导致的系统出错事件。</li></ul><table><thead><tr><th>时间</th><th>事件</th></tr></thead><tbody><tr><td>2021 年 7 月</td><td>中国 Bilibili 公司由于 SLB Lua 配置计算出错陷入死循环导致网站宕机</td></tr><tr><td>2021 年 10 月</td><td>韩国 KT 公司由于路由配置错误导致在全国范围内遭受重大网络中断</td></tr></tbody></table><p>表 1 配置导致的系统出错事件</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="12-声明式配置分类">1.2 声明式配置分类<a class="hash-link" href="#12-声明式配置分类" title="Direct link to heading">​</a></h3><p>云原生时代带来了如雨后春笋般的技术发展，出现了大量面向终态的声明式配置实践，如图 1 所示，声明式配置一般可分为如下几种方式。
<img loading="lazy" src="/zh-CN/assets/images/01-declarative-config-e5396685e3f3498f4b59854f8cf5eecb.png" width="1796" height="1076">
图 1 声明式配置方式分类</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="121-结构化-structured-的-kv">1.2.1 结构化 (Structured) 的 KV<a class="hash-link" href="#121-结构化-structured-的-kv" title="Direct link to heading">​</a></h4><ul><li>能力<ul><li>结构化 kv 满足最小数据化声明需求（int, string, list, dict 等）</li><li>随着云原生技术快速发展应用，声明式 API 满足 X as Data 发展诉求</li><li>面向机器可读可写，面向人类可读</li></ul></li><li>优势<ul><li>语法简单，易于编写和阅读</li><li>多语言 API 丰富</li><li>有各种 Path 工具方便数据查询，如 XPath, JsonPath 等</li></ul></li><li>痛点<ul><li>冗余信息多：当配置规模较大时，维护和阅读配置很困难，因为重要的配置信息被淹没在了大量不相关的重复细节中</li><li>功能性不足<ul><li>约束校验能力</li><li>复杂逻辑编写能力</li><li>测试、调试能力</li><li>不易抽象和复用</li><li>Kustomize 的 Patch 比较定制，基本是通过固定几种 Patch Merge 策略</li></ul></li></ul></li><li>代表技术<ul><li>JSON/YAML：非常方便阅读，以及自动化处理，不同的语言均具有丰富的 API 支持。</li><li><a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">Kustomize</a>：提供了一种无需<strong>模板</strong>和 <strong>DSL</strong> 即可自定义 Kubernetes 资源基础配置和差异化配置的解决方案，本身不解决约束的问题，需要配合大量的额外工具进行约束检查如 <a href="https://github.com/stackrox/kube-linter" target="_blank" rel="noopener noreferrer">Kube-linter</a>、<a href="https://github.com/bridgecrewio/checkov" target="_blank" rel="noopener noreferrer">Checkov</a> 等检查工具，图 2 示出了 Kustomize 的典型工作方式。</li></ul></li></ul><p><img loading="lazy" src="/zh-CN/assets/images/02-kustomize-8aa6da28d0aa5551360333a978452f23.png" width="1222" height="1220">
图 2 Kustomize 典型工作方式</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="123-模版化-templated-的-kv">1.2.3 模版化 (Templated) 的 KV<a class="hash-link" href="#123-模版化-templated-的-kv" title="Direct link to heading">​</a></h4><ul><li>能力<ul><li>赋予静态配置数据动态参数的能力，一份模版+动态参数输出不同的静态配置数据</li></ul></li><li>优势<ul><li>简单的配置逻辑，循环支持</li><li>支持外部动态参数输入模版</li></ul></li><li>痛点<ul><li>容易落入所有配置参数都是模版参数的陷阱</li><li>当配置规模变大时，开发者和工具都难以维护和分析它们</li></ul></li><li>代表技术<ul><li><a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">Helm</a>：Kubernetes 资源的包管理工具，通过配置模版管理 Kubernetes 资源配置。图 3 示出了一个 Helm Jekins Package ConfigMap 配置模版，可以看出这些模版本身都十分短小，可以书写简单的逻辑，适合 Kubernetes 基础组件固定的一系列资源配置通过包管理+额外的配置参数进行安装。相比于单纯的模版化的 KV，Helm 一定程度上提供了模版存储/引用和语义化版本管理的能力相比于 Kustomize 更适合管理外部 Charts, 但是在多环境、多租户的配置管理上不太擅长。</li></ul></li></ul><p><img loading="lazy" src="/zh-CN/assets/images/03-helm-88b0bd224c35a3f803c1fda38413ff13.png" width="2108" height="1248">
图 3 Helm Jekins Package ConfigMap 配置模版</p><ul><li>其他各种配置模版：Java Velocity, Go Template 等文本模板引擎非常适合 HTML 编写模板。但是在配置场景中使用时，存在所有配置字段即模版参数的风险，开发者和工具都难以维护和分析它们。</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="123-代码化-programmable-的-kv">1.2.3 代码化 (Programmable) 的 KV<a class="hash-link" href="#123-代码化-programmable-的-kv" title="Direct link to heading">​</a></h4><ul><li>概念<ul><li>Configuration as Code (CaC), 使用代码产生配置，就像工程师们只需要写高级 GPL 代码，而不是手工编写容易出错而且难以理解的服务器二进制代码一样。</li><li>配置变更同代码变更同样严肃地对待，同样可以执行单元测试、集成测试等</li><li>代码模块化和重用是维护配置代码比手动编辑 JSON/YAML 等配置文件更容易的一个关键原因</li></ul></li><li>能力<ul><li>必要的编程语言元素（变量定义、逻辑判断、循环、断言等）</li><li>必要的模板化能力（支持定义数据模版，并用模版得到新的配置数据）</li><li>代码模块化能力：结构 + 包管理</li><li>面向人类可读可写，面向机器部分可读可写</li></ul></li><li>优势<ul><li>必要的编程能力</li><li>代码模块化与抽象</li><li>可以抽象配置模版+并使用配置覆盖</li></ul></li><li>痛点<ul><li>类型检查不足</li><li>运行时错误</li><li>约束能力不足</li></ul></li><li>代表技术：<ul><li><a href="https://github.com/rix0rrr/gcl" target="_blank" rel="noopener noreferrer">GCL</a>：一种 Python 实现的声明式配置编程语言，提供了必要的语言能力支持模版抽象，但编译器本身是 Python 编写，且语言本身是解释执行，对于大的模版实例 (比如 K8s 模型) 性能较差。</li><li><a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener noreferrer">HCL</a>：一种 Go 实现结构化配置语言，原生语法受到 libucl、nginx 配置等的启发，用于创建对人类和机器都友好的结构化配置语言，主要针对 devops 工具、服务器配置以及 Terraform 中定义资源配置等。</li><li><a href="https://github.com/google/jsonnet" target="_blank" rel="noopener noreferrer">Jsonnet</a>：一种 C++ 实现的数据模板语言，适用于应用程序和工具开发人员，可以生成配置数据并且无副作用组织、简化、统一管理庞大的配置。</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="124-类型化-typed-的-kv">1.2.4 类型化 (Typed) 的 KV<a class="hash-link" href="#124-类型化-typed-的-kv" title="Direct link to heading">​</a></h4><ul><li>能力<ul><li>基于代码化 KV，类型化 KV 多了类型检查和约束的能力</li></ul></li><li>优势<ul><li>配置合并完全幂等，天然防止配置冲突</li><li>丰富的配置约束语法用于编写约束</li><li>将类型和值约束编写抽象为同一种形式，编写简单</li><li>配置顺序无关</li></ul></li><li>痛点<ul><li>图合并和幂等合并等概念复杂，用户理解成本较高</li><li>类型和值混合定义提高抽象程度的同时提升了用户的理解成本，并且所有约束在运行时进行检查，大规模配置代码下有性能瓶颈</li><li>对于想要配置覆盖、修改的多租户、多环境场景难以实现</li><li>对于带条件的约束场景，定义和校验混合定义编写用户界面不友好</li></ul></li><li>代表技术：<ul><li><a href="https://github.com/cue-lang/cue" target="_blank" rel="noopener noreferrer">CUE</a>：CUE 解决的核心问题是“类型检查”，主要应用于配置约束校验场景及简单的云原生配置场景</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="125-模型化-structural-的-kv">1.2.5 模型化 (Structural) 的 KV<a class="hash-link" href="#125-模型化-structural-的-kv" title="Direct link to heading">​</a></h4><ul><li>优势<ul><li>以高级语言建模能力为核心描述<ul><li>模型复用</li><li>不可变性</li><li>约束校验</li></ul></li><li>引入可分块、可扩展的 KV 配置块编写方式</li><li>类高级编程语言的编写、测试方式</li><li>语言内置的强校验、强约束支持</li><li>面向人类可读可写，面向机器部分可读可写</li></ul></li><li>不足<ul><li>扩展新模型及生态构建需要一定的研发成本</li></ul></li><li>代表技术：<a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">KCL</a>：一种 Rust 实现的声明式配置策略编程语言，把运维类研发统一为一种声明式的代码编写，可以针对差异化应用交付场景抽象出用户模型并添加相应的约束能力，期望借助可编程 devops 解决规模化运维场景中的配置策略编写的效率和可扩展性等问题。图 4 示出了一个 KCL 编写应用交付配置代码的典型场景</li></ul><p><img loading="lazy" src="/zh-CN/assets/images/04-kcl-app-code-d82ba09686d177a29b92ebf03c3c41dd.png" width="962" height="1030">
图 4 使用 KCL 编写应用交付配置代码</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="13-不同声明式配置方式的选择标准与最佳实践">1.3 不同声明式配置方式的选择标准与最佳实践<a class="hash-link" href="#13-不同声明式配置方式的选择标准与最佳实践" title="Direct link to heading">​</a></h3><ul><li>配置的规模：对于小规模的配置场景，完全可以使用 YAML/JSON 等配置，比如应用自身的简单配置，CI/CD 的配置。此外对于小规模配置场景存在的多环境、多租户等需求可以借助 Kustomize 的 overlay 能力实现简单配置的合并覆盖等操作。</li><li>模型抽象与约束的必要性：对于较大规模的配置场景特别是对多租户、多环境等有配置模型和运维特性研发和沉淀迫切需求的，可以使用代码化、类型化和模型化的 KV 方式。</li></ul><p>此外，从不同声明式配置方式的使用场景出发</p><ul><li>如果需要编写结构化的静态的 K-V，或使用 Kubernetes 原生的技术工具，建议选择 YAML</li><li>如果希望引入编程语言便利性以消除文本(如 YAML、JSON) 模板，有良好的可读性，或者已是 <a href="https://www.terraform.io" target="_blank" rel="noopener noreferrer">Terraform</a> 的用户，建议选择 HCL</li><li>如果希望引入类型功能提升稳定性，维护可扩展的配置文件，建议选择 CUE 之类的数据约束语言</li><li>如果希望以现代语言方式编写复杂类型和建模，维护可扩展的配置文件，原生的纯函数和策略，和生产级的性能和自动化，建议选择 KCL</li></ul><p>不同于社区中的其他同类型领域语言，KCL 是一种面向应用研发人员并采纳了现代语言设计和技术的静态强类型编译语言</p><blockquote><p>注意，本文将不会讨论通用语言编写配置的情况，通用语言一般是 Overkill 的，即远远超过了需要解决的问题，通用语言存在各式各样的安全问题，比如能力边界问题 (启动本地线程、访问 IO, 网络，代码死循环等不安全隐患)，比如像音乐领域就有专门的音符去表示音乐，方便学习与交流，不是一般文字语言可以表述清楚的。</p><p>此外，通用语言因为本身就样式繁多，存在统一维护、管理和自动化的成本，通用语言一般用来编写客户端运行时，是服务端运行时的一个延续，不适合编写与运行时无关的配置，最终被编译为二进制从进程启动，稳定性和扩展性不好控制，而配置语言往往编写的是数据，再搭配以简单的逻辑，描述的是期望的最终结果，然后由编译器或者引擎来消费这个期望结果。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="二kcl-的核心设计与应用场景">二、KCL 的核心设计与应用场景<a class="hash-link" href="#二kcl-的核心设计与应用场景" title="Direct link to heading">​</a></h2><p>Kusion 配置语言（KCL）是一个开源的基于约束的记录及函数语言。KCL 通过成熟的编程语言技术和实践来改进对大量繁杂配置的编写，致力于构建围绕配置的更好的模块化、扩展性和稳定性，更简单的逻辑编写，以及更快的自动化集成和良好的生态延展性。</p><p>KCL 的核心特性是其<strong>建模</strong>和<strong>约束</strong>能力，KCL 核心功能基本围绕 KCL 这个两个核心特性展开，此外 KCL 遵循以用户为中心的配置理念而设计其核心特性，可以从两个方面理解：</p><ul><li><strong>以领域模型为中心的配置视图</strong>：借助 KCL 语言丰富的特性及 <a href="https://kusionstack.io/docs/reference/cli/openapi/quick-start" target="_blank" rel="noopener noreferrer">KCL OpenAPI</a> 等工具，可以将社区中广泛的、设计良好的模型直接集成到 KCL 中（比如 K8s 资源模型），用户也可以根据自己的业务场景设计、实现自己的 KCL 模型 (库) ，形成一整套领域模型架构交由其他配置终端用户使用。</li><li><strong>以终端用户为中心的配置视图</strong>：借助 KCL 的代码封装、抽象和复用能力，可以对模型架构进行进一步抽象和简化（比如将 K8s 资源模型抽象为以应用为核心的 Server 模型），做到<strong>最小化终端用户配置输入</strong>，简化用户的配置界面，方便手动或者使用自动化 API 对其进行修改。</li></ul><p>不论是以何为中心的配置视图，对于代码而言（包括配置代码）都存在对配置数据约束的需求，比如类型约束、配置字段必选/可选约束、范围约束、不可变性约束等，这也是 KCL 致力于解决的核心问题之一。综上，KCL 是一个开源的基于约束和声明的函数式语言，KCL 主要包含如图 5 所示的核心特性：
<img loading="lazy" src="/zh-CN/assets/images/05-kcl-core-feature-07f8b663f646233ca933999c6d5eb01d.png" width="892" height="878">
图 5 KCL 核心特性</p><ul><li><strong>简单易用</strong>：源于 Python、Golang 等高级语言，采纳函数式编程语言特性，低副作用</li><li><strong>设计良好</strong>：独立的 Spec 驱动的语法、语义、运行时和系统库设计</li><li><strong>快速建模</strong>：以 <a href="https://kusionstack.io/docs/reference/lang/lang/tour#schema" target="_blank" rel="noopener noreferrer">Schema</a> 为中心的配置类型及模块化抽象</li><li><strong>功能完备</strong>：基于 <a href="https://kusionstack.io/docs/reference/lang/lang/codelab/simple" target="_blank" rel="noopener noreferrer">Config</a>、<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#schema" target="_blank" rel="noopener noreferrer">Schema</a>、<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#function" target="_blank" rel="noopener noreferrer">Lambda</a>、<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#rule" target="_blank" rel="noopener noreferrer">Rule</a> 的配置及其模型、逻辑和策略编写</li><li><strong>可靠稳定</strong>：依赖<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#type-system" target="_blank" rel="noopener noreferrer">静态类型系统</a>、<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#validation" target="_blank" rel="noopener noreferrer">约束</a>和<a href="https://kusionstack.io/docs/reference/lang/lang/tour#rule" target="_blank" rel="noopener noreferrer">自定义规则</a>的配置稳定性</li><li><strong>强可扩展</strong>：通过独立配置块<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#-operators-1" target="_blank" rel="noopener noreferrer">自动合并机制</a>保证配置编写的高可扩展性</li><li><strong>易自动化</strong>：<a href="https://kusionstack.io/docs/reference/lang/lang/tour/#kcl-cli-variable-override" target="_blank" rel="noopener noreferrer">CRUD APIs</a>，<a href="https://kusionstack.io/docs/reference/lang/xlang-api/overview" target="_blank" rel="noopener noreferrer">多语言 SDK</a>，<a href="https://github.com/KusionStack/kcl-plugin" target="_blank" rel="noopener noreferrer">语言插件</a> 构成的梯度自动化方案</li><li><strong>极致性能</strong>：使用 Rust &amp; C，<a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a> 实现，支持编译到本地代码和 <a href="https://webassembly.org/" target="_blank" rel="noopener noreferrer">WASM</a> 的高性能编译时和运行时</li><li><strong>API 亲和</strong>：原生支持 <a href="https://github.com/KusionStack/kcl-openapi" target="_blank" rel="noopener noreferrer">OpenAPI</a>、 Kubernetes CRD， Kubernetes YAML 等 API 生态规范</li><li><strong>开发友好</strong>：<a href="https://kusionstack.io/docs/reference/cli/kcl/" target="_blank" rel="noopener noreferrer">语言工具</a> (Format，Lint，Test，Vet，Doc 等)、 <a href="https://github.com/KusionStack/vscode-kcl" target="_blank" rel="noopener noreferrer">IDE 插件</a> 构建良好的研发体验</li><li><strong>安全可控</strong>：面向领域，不原生提供线程、IO 等系统级功能，低噪音，低安全风险，易维护，易治理</li><li><strong>生产可用</strong>：广泛应用在蚂蚁集团平台工程及自动化的生产环境实践中</li></ul><p><img loading="lazy" src="/zh-CN/assets/images/06-kcl-code-design-a7eb793b08f0d9e089d7f17d7971749e.png" width="520" height="394">
图 6 KCL 语言核心设计</p><p>更多语言设计和能力详见 <a href="https://kusionstack.io/docs/reference/lang/lang/tour" target="_blank" rel="noopener noreferrer">KCL 文档</a>，尽管 KCL 不是通用语言，但它有相应的应用场景，如图 6 所示，研发者可以通过 KCL 编写<strong>配置(config)</strong>、<strong>模型(schema)</strong>、<strong>函数(lambda)</strong>及<strong>规则(rule)</strong>，其中 Config 用于定义数据，Schema 用于对数据的模型定义进行描述，Rule 用于对数据进行校验，并且 Schema 和 Rule 还可以组合使用用于完整描述数据的模型及其约束，此外还可以使用 KCL 中的 lambda 纯函数进行数据代码组织，将常用代码封装起来,在需要使用时可以直接调用。</p><p>对于使用场景而言，KCL 的可以进行结构化 KV 数据验证、复杂配置模型定义与抽象、强约束校验避免配置错误、分块编写及配置合并能力、自动化集成和工程扩展等能力，下面针对这些功能和使用场景进行阐述。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="21-结构化-kv-数据验证">2.1 结构化 KV 数据验证<a class="hash-link" href="#21-结构化-kv-数据验证" title="Direct link to heading">​</a></h3><p>如图 7 所示，KCL 支持对 JSON/YAML 数据进行格式校验。作为一种配置语言，KCL 在验证方面几乎涵盖了 OpenAPI 校验的所有功能。在 KCL 中可以通过一个结构定义来约束配置数据，同时支持通过 check 块自定义约束规则，在 schema 中书写校验表达式对 schema 定义的属性进行校验和约束。通过 check 表达式可以非常清晰简单地校验输入的 JSON/YAML 是否满足相应的 schema 结构定义与 check 约束。
<img loading="lazy" src="/zh-CN/assets/images/07-kcl-validation-49d29ddd21947f4c239531c5db1efc8e.png" width="481" height="173">
图 7 KCL 中结构化 KV 校验方式</p><p>基于此，KCL 提供了相应的<a href="https://kusionstack.io/docs/reference/cli/kcl/vet" target="_blank" rel="noopener noreferrer">校验工具</a>直接对 JSON/YAML 数据进行校验。此外，通过 KCL schema 的 check 表达式可以非常清晰简单地校验输入的 JSON 是否满足相应的 schema 结构定义与 check 约束。此外，基于此能力可以构建如图 8 所示的 KV 校验可视化产品。
<img loading="lazy" src="/zh-CN/assets/images/08-kcl-validation-ui-969312043d6654caf53c8a23854d0ec1.png" width="460" height="388">
图 8 基于 KCL 结构化 KV 校验能力构建的可视化产品界面</p><ul><li>更多参考文档：KCL Vet 工具：<a href="https://kusionstack.io/docs/reference/cli/kcl/vet" target="_blank" rel="noopener noreferrer">https://kusionstack.io/docs/reference/cli/kcl/vet</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="22-复杂配置模型定义与抽象">2.2 复杂配置模型定义与抽象<a class="hash-link" href="#22-复杂配置模型定义与抽象" title="Direct link to heading">​</a></h3><p>如图 9 所示，借助 KCL 语言丰富的特性及 <a href="https://kusionstack.io/docs/reference/cli/openapi/quick-start" target="_blank" rel="noopener noreferrer">KCL OpenAPI</a> 等工具，可以将社区中广泛的、设计良好的模型直接集成到 KCL 中（比如 K8s 资源模型 CRD），用户也可以根据自己的业务场景设计、实现自己的 KCL 模型 (库) ，形成一整套领域模型架构交由其他配置终端用户使用。
<img loading="lazy" src="/zh-CN/assets/images/09-kcl-modeling-b4ad4cc5ee1ec1f61c87ac89f42c466e.png" width="753" height="389">
图 9 KCL 复杂配置建模的一般方式</p><p>基于此，可以像图 10 示出的那样用一个大的 <a href="https://github.com/KusionStack/konfig" target="_blank" rel="noopener noreferrer">Konfig 仓库</a> 管理全部的 KCL 配置代码，将业务配置代码 (应用代码)、基础配置代码 (核心模型+底层模型)在一个大库中，方便代码间的版本依赖管理，自动化系统处理也比较简单，定位唯一代码库的目录及文件即可，代码互通，统一管理，便于查找、修改、维护，可以使用统一的 CI/CD 流程进行配置管理（此外，大库模式也是 Google 等头部互联网公司内部实践的模式）。
<img loading="lazy" src="/zh-CN/assets/images/10-kcl-konfig-bd148de871df5c5a301313ae17d0be0b.png" width="363" height="356">
图 10 使用 KCL 的语言能力集成领域模型并抽象用户模型并使用</p><ul><li>更多参考文档<ul><li>KCL Schema：<a href="https://kusionstack.io/docs/reference/lang/lang/tour#schema" target="_blank" rel="noopener noreferrer">https://kusionstack.io/docs/reference/lang/lang/tour#schema</a></li><li>KCL OpenAPI 规范：<a href="https://kusionstack.io/docs/reference/cli/openapi/spec" target="_blank" rel="noopener noreferrer">https://kusionstack.io/docs/reference/cli/openapi/spec</a></li><li>KCL Konfig 配置大库概览：<a href="https://kusionstack.io/docs/reference/konfig/overview" target="_blank" rel="noopener noreferrer">https://kusionstack.io/docs/reference/konfig/overview</a></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="23-强约束校验避免配置错误">2.3 强约束校验避免配置错误<a class="hash-link" href="#23-强约束校验避免配置错误" title="Direct link to heading">​</a></h3><p>如图 11 所示，在 KCL 中可以通过丰富的强约束校验手段避免配置错误：
<img loading="lazy" src="/zh-CN/assets/images/11-kcl-constraint-e336ac2830a49b4e347a75c40a22cf9d.png" width="569" height="326">
图 11 KCL 强约束校验手段</p><ul><li>KCL 语言的类型系统被设计为静态的，类型和值定义分离，支持编译时类型推导和类型检查，静态类型不仅仅可以提前在编译时分析大部分的类型错误，还可以降低后端运行时的动态类型检查的性能损耗。此外，KCL Schema 结构的属性强制为非空，可以有效避免配置遗漏。</li><li>当需要导出的 KCL 配置被声明之后，它们的类型和值均不能发生变化，这样的静态特性保证了配置不会被随意篡改。</li><li>KCL 支持通过结构体内置的校验规则进一步保障稳定性。比如对于如图 12 所示的 KCL 代码，，在 <code>App</code> 中定义对 <code>containerPort</code>、<code>services</code>、<code>volumes</code> 的校验规则，目前校验规则在运行时执行判断，后续 KCL 会尝试通过编译时的静态分析对规则进行判断从而发现问题。</li></ul><p><img loading="lazy" src="/zh-CN/assets/images/12-kcl-app-schema-0cb24fd30175faaffb6d06e3a795c260.png" width="1364" height="588">
图 12 带规则约束的 KCL 代码校验</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="24-分块编写及配置合并">2.4 分块编写及配置合并<a class="hash-link" href="#24-分块编写及配置合并" title="Direct link to heading">​</a></h3><p>KCL 提供了配置分块编写及自动合并配置的能力，并且支持幂等合并、补丁合并和唯一配置合并等策略。幂等合并中的多份配置需要满足交换律，并且需要开发人员手动处理基础配置和不同环境配置冲突。 补丁合并作为一个覆盖功能，包括覆盖、删除和添加。唯一的配置要求配置块是全局唯一的并且未修改或以任何形式重新定义。 KCL 通过多种合并策略简化了用户侧的协同开发，减少了配置之间的耦合。</p><p>如图 13 所示，对于存在基线配置、多环境和多租户的应用配置场景，有一个基本配置 base.k。 开发和 SRE 分别维护生产和开发环境的配置 base.k 和 prod.k，他们的配置互不影响，由 KCL 编译器合并成一个 prod 环境的等效配置代码。
<img loading="lazy" src="/zh-CN/assets/images/13-kcl-isolated-config-4bbfae7a87567d43c1285fdf93e62ad7.png" width="1638" height="842">
图 13 多环境场景配置分块编写实例</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="25-自动化集成">2.5 自动化集成<a class="hash-link" href="#25-自动化集成" title="Direct link to heading">​</a></h3><p>在 KCL 中提供了很多自动化相关的能力，主要包括工具和多语言 API。 通过 <code>package_identifier : key_identifier</code>的模式支持对任意配置键值的索引，从而完成对任意键值的增删改查。比如图 14 所示修改某个应用配置的镜像内容，可以直接执行如下指令修改镜像，修改前后的 diff 如下图所示。</p><p><img loading="lazy" src="/zh-CN/assets/images/14-kcl-image-update-da47dd269560008f15f287c5a4adb005.png" width="1828" height="502">
图 14 使用 KCL CLI/API 自动修改应用配置镜像</p><p>此外，可以基于 KCL 的自动化能力实现如图 15 所示的一镜交付及自动化运维能力并集成到 CI/CD 当中。
<img loading="lazy" src="/zh-CN/assets/images/15-kcl-automation-8c88e4bbdd38b5040457f647986a89c3.png" width="890" height="247">
图 15 典型 KCL 自动化集成链路</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="三kcl-与其他声明式配置的对比">三、KCL 与其他声明式配置的对比<a class="hash-link" href="#三kcl-与其他声明式配置的对比" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="31-vs-jsonyaml">3.1 vs. JSON/YAML<a class="hash-link" href="#31-vs-jsonyaml" title="Direct link to heading">​</a></h3><p>YAML/JSON 配置等适合小规模的配置场景，对于大规模且需要频繁修改的云原生配置场景，比较适合 KCL 比较适合，其中涉及到主要差异是配置数据抽象与展开的差异：</p><ul><li>对于 JSON/YAML 等静态配置数据展开的好处是：简单、易读、易于处理，但是随着静态配置规模的增加，当配置规模较大时，JSON/YAML 等文件维护和阅读配置很困难，因为重要的配置信息被<strong>淹没在了大量不相关的重复细节</strong>中。</li><li>对于使用 KCL 语言进行配置抽象的好处是：对于静态数据，抽象一层的好处这意味着整体系统具有<strong>部署的灵活性</strong>，不同的配置环境、配置租户、运行时可能会对静态数据具有不同的要求，甚至不同的组织可能有不同的规范和产品要求，可以使用 KCL 将最需要、最常修改的配置暴露给用户，对差异化的配置进行抽象，抽象的好处是可以支持不同的配置需求。并且借助 KCL 语言级别的自动化集成能力，还可以很好地支持不同的语言，不同的配置 UI 等。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="32-vs-kustomize">3.2 vs. Kustomize<a class="hash-link" href="#32-vs-kustomize" title="Direct link to heading">​</a></h3><p>Kustomize 的核心能力是其 Overlay 能力，并 Kustomize 支持文件级的覆盖，但是存在会存在多个覆盖链条的问题，因为找到具体字段值的声明并不能保证这是最终值，因为其他地方出现的另一个具体值可以覆盖它，对于复杂的场景，Kustomize 文件的继承链检索往往不如 KCL 代码继承链检索方便，需要仔细考虑指定的配置文件覆盖顺序。此外，Kustomize 不能解决 YAML 配置编写、配置约束校验和模型抽象与开发等问题，较为适用于简单的配置场景，当配置组件增多时，对于配置的修改仍然会陷入大量重复不相关的配置细节中，并且在 IDE 中不能很好地显示配置之间的依赖和覆盖关系情况，只能通过搜索/替换等批量修改配置。</p><p>在 KCL 中，配置合并的操作可以细粒度到代码中每一个配置字段，并且可以灵活的设置合并策略，并不局限于资源整体，并且通过 KCL 的 import 可以静态分析出配置之间的依赖关系。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="33-vs-hcl">3.3 vs. HCL<a class="hash-link" href="#33-vs-hcl" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="331-功能对比">3.3.1 功能对比<a class="hash-link" href="#331-功能对比" title="Direct link to heading">​</a></h4><table><thead><tr><th></th><th>HCL</th><th>KCL</th></tr></thead><tbody><tr><td>建模能力</td><td>通过 Terraform Go Provider Schema 定义，在用户界面不直接感知，此外编写复杂的 object 和必选/可选字段定义时用户界面较为繁琐</td><td>通过 KCL Schema 进行建模，通过语言级别的工程和部分面向对象特性，可以实现较高的模型抽象</td></tr><tr><td>约束能力</td><td>通过 Variable 的 condition 字段对动态参数进行约束，Resource 本身的约束需要通过 Go Provider Schema 定义或者结合 Sentinel/Rego 等策略语言完成，语言本身的完整能力不能自闭环，且实现方式不统一</td><td>以 Schema 为核心，在进行建模的同时定义其约束，在 KCL 内部自闭环并一统一方式实现，支持多种约束函数编写，支持可选/必选字段定义</td></tr><tr><td>扩展性</td><td>Terraform HCL 通过分文件进行 Override, 模式比较固定，能力受限。</td><td>KCL 可以自定义配置分块编写方式和多种合并策略，可以满足复杂的多租户、多环境配置场景需求</td></tr><tr><td>语言化编写能力</td><td>编写复杂的对象定义和必选/可选字段定义时用户界面较为繁琐</td><td>复杂的结构定义、约束场景编写简单，不借助其他外围 GPL 或工具，语言编写自闭环</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_mojV" id="332-举例">3.3.2 举例<a class="hash-link" href="#332-举例" title="Direct link to heading">​</a></h4><p><strong>Terraform HCL Variable 约束校验编写 vs. KCL Schema 声明式约束校验编写</strong></p><ul><li>HCL</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token string" style="color:#e3116c">"subnet_delegations"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name               </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service_delegation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      actions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null ? true </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alltrue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> d </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null ? true </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alltrue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null ? true </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alltrue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> d </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service_delegation </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> null ? true </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alltrue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> n </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subnet_delegations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service_delegation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>KCL</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">schema SubnetDelegation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service_delegation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceDelegation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema ServiceDelegation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actions?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 ? 标记可选属性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subnet_delegations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SubnetDelegation</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"subnet_delegations"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>此外，KCL 还可以像高级语言一样写类型，写继承，写内置的约束，这些功能是 HCL 所不具备的</p><ul><li>KCL 定义复杂的类型继承和约束</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">schema Person</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Employee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Person</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobTitle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">employee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Employee </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    firstName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Alice"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"White"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobTitle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"engineer"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>Terraform HCL 函数 vs. KCL Lambda 函数编写 + Plugin 函数编写</strong></p><ul><li><p>正如 <a href="https://www.terraform.io/language/functions" target="_blank" rel="noopener noreferrer">https://www.terraform.io/language/functions</a> 文档和 <a href="https://github.com/hashicorp/terraform/issues/27696" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform/issues/27696</a> 中展示的那样，Terraform HCL 提供了丰富的内置函数用于提供，但是并不支持用户在 Terraform 中使用 HCL 自定义函数 (或者需要编写复杂的 Go Provider 来模拟一个用户的本地自定义函数)；而 KCL 不仅支持用户使用 lambda 关键字直接在 KCL 代码中自定义函数，还支持使用 Python, Go 等语言为 KCL <a href="https://kusionstack.io/docs/reference/lang/plugin/overview" target="_blank" rel="noopener noreferrer">编写插件函数</a></p></li><li><p>KCL 自定义定义函数并调用</p></li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">add_func </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">two </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> add_func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>KCL 使用 Python 编写的插件函数</li><li>Python 代码 (hello/plugin.py)</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Copyright 2020 The KCL Authors. All rights reserved.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'name'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'hello'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'describe'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'hello doc'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'long_describe'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'long describe'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'version'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0.0.1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""add two numbers, and return result"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>KCL 调用插件代码</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> kcl_plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">two </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hello</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>HCL 删除 null 值与 KCL 使用 -n 编译参数删除 null 值</strong></p><ul><li>HCL</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">variable </span><span class="token string" style="color:#e3116c">"conf"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token builtin">type</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name        </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    steps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      args    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      command </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        limits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cpu    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          memory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requests </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cpu    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          memory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      script     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      workingDir </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">locals</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defaults</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conf </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> steps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> step </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">steps </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> step </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> null </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>KCL (编译参数添加 -n 忽略 null 值)</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">schema Param</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Resource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Step</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    command?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"limits"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"requests"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Resource</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    script?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workingDir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema K8sManifest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Param</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results?</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Step</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> K8sManifest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"conf"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>综上可以看出，在 KCL 中，通过 Schema 来声明方式定义其类型和约束，可以看出相比于 Terraform HCL, 在实现相同功能的情况下，KCL 的约束可以编写的更加简单 (不需要像 Terraform 那样重复地书写 validation 和 condition 字段)，并且额外提供了字段设置为可选的能力 (<code>?</code>运算符，不像 Terraform 配置字段默认可空，KCL Schema 字段默认必选)，结构更加分明，并且可以在代码层面直接获得类型检查和约束校验的能力。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="34-vs-cue">3.4 vs. CUE<a class="hash-link" href="#34-vs-cue" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="341-功能对比">3.4.1 功能对比<a class="hash-link" href="#341-功能对比" title="Direct link to heading">​</a></h4><table><thead><tr><th></th><th>CUE</th><th>KCL</th></tr></thead><tbody><tr><td>建模能力</td><td>通过 Struct 进行建模，无继承等特性，当模型定义之间无冲突时可以实现较高的抽象。由于 CUE 在运行时进行所有的约束检查，在大规模建模场景可能存在性能瓶颈</td><td>通过 KCL Schema 进行建模，通过语言级别的工程和部分面向对象特性（如单继承），可以实现较高的模型抽象。 KCL 是静态编译型语言，对于大规模建模场景开销较小</td></tr><tr><td>约束能力</td><td>CUE 将类型和值合并到一个概念中，通过各种语法简化了约束的编写，比如不需要泛型和枚举，求和类型和空值合并都是一回事</td><td>KCL 提供了跟更丰富的 check 声明式约束语法，编写起来更加容易，对于一些配置字段组合约束编写更加简单（能力上比 CUE 多了 if guard 组合约束，all/any/map/filter 等集合约束编写方式，编写更加容易）</td></tr><tr><td>分块编写能力</td><td>支持语言内部配置合并，CUE 的配置合并是完全幂等的，对于满足复杂的多租户、多环境配置场景的覆盖需求可能无法满足</td><td>KCL 可以自定义配置分块编写方式和多种合并策略，KCL 同时支持幂等和非幂等的合并策略,可以满足复杂的多租户、多环境配置场景需求</td></tr><tr><td>语言化编写能力</td><td>对于复杂的循环、条件约束场景编写复杂，对于需要进行配置精确修改的编写场景较为繁琐</td><td>复杂的结构定义、循环、条件约束场景编写简单</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_mojV" id="342-举例">3.4.2 举例<a class="hash-link" href="#342-举例" title="Direct link to heading">​</a></h4><p><strong>CUE 约束校验编写 vs. KCL Schema 声明式约束校验编写及配置分块编写能力</strong></p><p>CUE (执行命令 <code>cue export base.cue prod.cue</code>)</p><ul><li>base.cue</li></ul><div class="codeBlockContainer_I0IT language-cue theme-code-block"><div class="codeBlockContent_wNvx cue"><pre tabindex="0" class="prism-code language-cue codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// base.cue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import "list"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#App: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domainType: "Standard" | "Customized" | "Global",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort: &gt;=1 &amp; &lt;=65535,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes: [...#Volume],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services: [...#Service],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Service: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clusterIP: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if type == "ClusterIP" {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clusterIP: "None"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Volume: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container: string | *"*"  // The default value of `container` is "*"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mountPath: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _check: false &amp; list.Contains(["/", "/boot", "/home", "dev", "/etc", "/root"], mountPath),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app: #App &amp; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domainType: "Standard",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort: 80,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mountPath: "/tmp"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            clusterIP: "None",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: "ClusterIP"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>prod.cue</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">//</span><span class="token plain"> prod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#App &amp; {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conflicting values </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>KCL (执行命令 <code>kcl base.k prod.k</code>)</p><ul><li>base.k</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># base.k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema App</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domainType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Standard"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Customized"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Global"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Volume</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> containerPort </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">65535</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clusterIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $</span><span class="token builtin">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clusterIP </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"None"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> $</span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ClusterIP"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">schema Volume</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The default value of `container` is "*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mountPath </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/boot"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/home"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"dev"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/etc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/root"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> App </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    domainType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Standard"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mountPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/tmp"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            clusterIP </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"None"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $</span><span class="token builtin">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ClusterIP"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>prod.k</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># prod.k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> App </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 可以使用 = 属性运算符对 base app 的 containerPort 进行修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 可以使用 += 属性运算符对 base app 的 volumes 进行添加</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 此处表示在 prod 环境增加一个 volume, 一共两个 volume</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mountPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/tmp2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>此外由于 CUE 的幂等合并特性，在场景上并无法使用类似 kustomize 的 overlay 配置覆盖添加能力，比如上述的 base.cue 和 prod.cue 一起编译会报错。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="35-performance">3.5 Performance<a class="hash-link" href="#35-performance" title="Direct link to heading">​</a></h3><p>在代码规模较大或者计算量较高的场景情况下 KCL 比 CUE/Jsonnet/HCL 等语言性能更好 (CUE 等语言受限于运行时约束检查开销，而 KCL 是一个静态编译型语言)</p><ul><li>CUE (test.cue)</li></ul><div class="codeBlockContainer_I0IT language-cue theme-code-block"><div class="codeBlockContent_wNvx cue"><pre tabindex="0" class="prism-code language-cue codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import "list"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">temp: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i, _ in list.Range(0, 10000, 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "a\(i)": list.Max([1, 2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>KCL (test.k)</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">temp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"a${i}"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>Jsonnet (test.jsonnet)</li></ul><div class="codeBlockContainer_I0IT language-jsonnet theme-code-block"><div class="codeBlockContent_wNvx jsonnet"><pre tabindex="0" class="prism-code language-jsonnet codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">local a(x, y) = std.max(x, y);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temp: [a(1, 2) for i in std.range(0, 10000)],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>Terraform HCL (test.tf, 由于 terraform range 函数只支持最多 1024 个迭代器，将 range(10000) 拆分为 10 个子 range)</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r1"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r3"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r4"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r5"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r6"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r7"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r8"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r9"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token string" style="color:#e3116c">"r10"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">9000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>运行时间（考虑到生产环境的实际资源开销，本次测试以单核为准）</li></ul><table><thead><tr><th>环境</th><th>KCL v0.4.3 运行时间 (包含编译+运行时间)</th><th>CUE v0.4.3 运行时间 (包含编译+运行时间)</th><th>Jsonnet v0.18.0 运行时间 (包含编译+运行时间)</th><th>HCL in Terraform v1.3.0 运行时间 (包含编译+运行时间)</th></tr></thead><tbody><tr><td>OS: macOS 10.15.7; CPU: Intel(R) Core(TM) i7-8850H CPU @ 2.60GHz; Memory: 32 GB 2400 MHz DDR4; 不开启 NUMA</td><td>440 ms (kclvm_cli run test.k)</td><td>6290 ms (cue export test.cue)</td><td>1890 ms (jsonnet test.jsonnet)</td><td>1774 ms (terraform plan -parallelism=1)</td></tr></tbody></table><p>综上可以看出：CUE 和 KCL 均可以覆盖到绝大多数配置校验场景，并且均支持属性类型定义、配置默认值、约束校验等编写，但是 CUE 对于不同的约束条件场景无统一的写法，且不能很好地透出校验错误，KCL 使用 check 关键字作统一处理，支持用户自定义错误输出。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="四kcl-核心实现原理">四、KCL 核心实现原理<a class="hash-link" href="#四kcl-核心实现原理" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="41-kcl-技术架构">4.1 KCL 技术架构<a class="hash-link" href="#41-kcl-技术架构" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="/zh-CN/assets/images/16-kcl-compiler-arch-80e0de63d5a17ac656650bf408117ef4.png" width="1876" height="674">
图 16 KCL 编译器架构</p><p>如图 16 所示，KCL 编译器实现以 Spec 作为驱动（主要包含 KCL 语言规范，KCL 多语言集成规范、KCL OpenAPI 规范），KCL 是一个编译型的语言，整体保持与常规语言编译器相同的三段式架构，并在其中借助了 LLVM-IR 作为 KCL 连接 Native/WASM 代码的中间纽带，主要有以下 3 个核心工作：</p><ul><li>KCL AST 到 LLVM-IR 的翻译：通过遍历 KCL AST，根据 KCL 语言规范生成相应的 LLVM-IR 代码，相当于用户态代码。</li><li>KCL Runtime Lib：运行时辅助函数库，提供运行时 KCL 的值/类型计算、内存、上下文管理、内置库和插件库支持，相当于系统态代码。</li><li>用户态与系统态代码链接与执行：将用户态代码与系统态代码链接为一个动态链接库/WASM Module，最终通过统一的 Runner 模块执行编译后的 KCL 代码。</li></ul><p>此外 KCL 在语义检查器和和 Plugin 这块做了增强支持：</p><ul><li>Resolver<ul><li>静态类型推导与检查：可以在编译时进行类型推导和检查，避免运行时类型检查开销，可以作为 IDE 插件跳转、补全等功能支持和语义 API 构建(如 schema 模型查询、依赖分析等) 的良好基础</li><li>配置图合并：在编译过程对配置数据依赖图进行构建与合并，最终运行时仅进行少量计算即可得到最终的解</li><li>语义依赖图：通过内建语义依赖图，KCL 可以完成配置变更的依赖分析， 并且根据配置变更结果进行增量编译，对不变的配置进行缓存，可以提升端到端编译性能</li><li>Schema 为中心的面向对象特性：KCL 语言只保留了单继承的语法。同时 schema 可以通过 mixin 和 protocol 等特性混入复用相同的代码片段，对于不同的能力配套，可以通过 mixin 机制编写，并通过 mixin 声明的方式“混入”到不同的结构体中</li></ul></li><li>Plugin: 可以使用 Python/Go 编写扩展库，主要包含一些领域能力，如访问网络或数据库等。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="42-kcl-配置图模型">4.2 KCL 配置图模型<a class="hash-link" href="#42-kcl-配置图模型" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="/zh-CN/assets/images/17-kcl-graph-unification-2210da55069341349429e2ff7c21c2aa.png" width="1770" height="886">
图 17 KCL 配置图模型</p><p>图 17 示出了 KCL 内部的配置图模型，首先 KCL 代码在编译过程中形成两张图（用户不同配置直接的引用和从属关系一般形式一张有向无环图），分别对应结构体内部声明代码及结构体使用声明代码。编译过程可以简单分为三步。</p><ul><li>首先定义平台侧的结构体并形成结构体内部声明代码图</li><li>其次声明并合并不同用户侧配置代码图</li><li>最后将用户侧配置代码图计算的结果代入平台侧结构体内部声明代码图求解，最终得到完整配置图定义</li></ul><p>通过这样简单的计算过程，可以在编译时完成大部分代换运算，最终运行时仅进行少量计算即可得到最终的解。同时在编译合并图过程中仍然能够执行类型检查和值的检查，区别是类型检查是做泛化、取偏序上确界（检查某个变量的值是否满足既定类型或者既定类型的子类型），值检查是做特化、取偏序下确界（比如将两个字典合并为一个字典）。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="五小结">五、小结<a class="hash-link" href="#五小结" title="Direct link to heading">​</a></h2><p>文本对声明式配置技术做了整体概述，其中重点阐述了 KCL 概念、核心设计、使用场景以及与其他配置语言的对比，期望帮助大家更好的理解声明式配置技术及 KCL 语言。更多 KusionStack 的概念、背景、设计与用户案例相关的内容，欢迎访问 <a href="https://kusionstack.io/" target="_blank" rel="noopener noreferrer">https://kusionstack.io/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="六参考">六、参考<a class="hash-link" href="#六参考" title="Direct link to heading">​</a></h2><ul><li>KusionStack Cloud Native Configuration Practice Blog: <a href="https://kusionstack.io/blog/2021-kusion-intro" target="_blank" rel="noopener noreferrer">https://kusionstack.io/blog/2021-kusion-intro</a></li><li>Terraform Language: <a href="https://www.terraform.io/language" target="_blank" rel="noopener noreferrer">https://www.terraform.io/language</a></li><li>Terraform Provider Kubernetes: <a href="https://github.com/hashicorp/terraform-provider-kubernetes" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-kubernetes</a></li><li>Terraform Provider AWS: <a href="https://github.com/hashicorp/terraform-provider-aws" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/terraform-provider-aws</a></li><li>Pulumi: <a href="https://www.pulumi.com/docs/" target="_blank" rel="noopener noreferrer">https://www.pulumi.com/docs/</a></li><li>Pulumi vs. Terraform: <a href="https://www.pulumi.com/docs/intro/vs/terraform/" target="_blank" rel="noopener noreferrer">https://www.pulumi.com/docs/intro/vs/terraform/</a></li><li>Google SRE Work Book Configuration Design: <a href="https://sre.google/workbook/configuration-design/" target="_blank" rel="noopener noreferrer">https://sre.google/workbook/configuration-design/</a></li><li>Google Borg Paper: <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/43438.pdf" target="_blank" rel="noopener noreferrer">https://storage.googleapis.com/pub-tools-public-publication-data/pdf/43438.pdf</a></li><li>Holistic Configuration Management at Facebook: <a href="https://sigops.org/s/conferences/sosp/2015/current/2015-Monterey/printable/008-tang.pdf" target="_blank" rel="noopener noreferrer">https://sigops.org/s/conferences/sosp/2015/current/2015-Monterey/printable/008-tang.pdf</a></li><li>JSON Spec: <a href="https://www.json.org/json-en.html" target="_blank" rel="noopener noreferrer">https://www.json.org/json-en.html</a></li><li>YAML Spec: <a href="https://yaml.org/spec/" target="_blank" rel="noopener noreferrer">https://yaml.org/spec/</a></li><li>GCL: <a href="https://github.com/rix0rrr/gcl" target="_blank" rel="noopener noreferrer">https://github.com/rix0rrr/gcl</a></li><li>HCL: <a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/hcl</a></li><li>CUE: <a href="https://github.com/cue-lang/cue" target="_blank" rel="noopener noreferrer">https://github.com/cue-lang/cue</a></li><li>Jsonnet: <a href="https://github.com/google/jsonnet" target="_blank" rel="noopener noreferrer">https://github.com/google/jsonnet</a></li><li>Dhall: <a href="https://github.com/dhall-lang/dhall-lang" target="_blank" rel="noopener noreferrer">https://github.com/dhall-lang/dhall-lang</a></li><li>Thrift: <a href="https://github.com/Thriftpy/thriftpy2" target="_blank" rel="noopener noreferrer">https://github.com/Thriftpy/thriftpy2</a></li><li>Kustomize: <a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">https://kustomize.io/</a></li><li>Kube-linter: <a href="https://github.com/stackrox/kube-linter" target="_blank" rel="noopener noreferrer">https://github.com/stackrox/kube-linter</a></li><li>Checkov: <a href="https://github.com/bridgecrewio/checkov" target="_blank" rel="noopener noreferrer">https://github.com/bridgecrewio/checkov</a></li><li>KCL Documents: <a href="https://kusionstack.io/docs/reference/lang/lang/tour" target="_blank" rel="noopener noreferrer">https://kusionstack.io/docs/reference/lang/lang/tour</a></li><li>How Terraform Works: A Visual Intro: <a href="https://betterprogramming.pub/how-terraform-works-a-visual-intro-6328cddbe067" target="_blank" rel="noopener noreferrer">https://betterprogramming.pub/how-terraform-works-a-visual-intro-6328cddbe067</a> </li><li>How Terraform Works: Modules Illustrated: <a href="https://awstip.com/terraform-modules-illustrate-26cbc48be83a" target="_blank" rel="noopener noreferrer">https://awstip.com/terraform-modules-illustrate-26cbc48be83a</a></li><li>Helm: <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">https://helm.sh/</a></li><li>Helm vs. Kustomize: <a href="https://harness.io/blog/helm-vs-kustomize" target="_blank" rel="noopener noreferrer">https://harness.io/blog/helm-vs-kustomize</a></li><li>KubeVela: <a href="https://kubevela.io/docs/" target="_blank" rel="noopener noreferrer">https://kubevela.io/docs/</a></li></ul>]]></content:encoded>
            <category>KCL</category>
            <category>Configuration</category>
        </item>
        <item>
            <title><![CDATA[KCL云原生配置策略语言]]></title>
            <link>https://kcl-lang.github.io/zh-CN/blog/2021-kcl-intro</link>
            <guid>2021-kcl-intro</guid>
            <pubDate>Tue, 03 Aug 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍KCL云原生配置语言在蚂蚁的诞生背景、语言特性、实践探索和未来的发展思考。]]></description>
            <content:encoded><![CDATA[<p>介绍KCL云原生配置语言在蚂蚁的诞生背景、语言特性、实践探索和未来的发展思考。</p><ul><li>简介：<a href="https://giac.msup.com.cn/course?id=15307" target="_blank" rel="noopener noreferrer">https://giac.msup.com.cn/course?id=15307</a></li><li>内容：<a href="https://segmentfault.com/a/1190000040455559" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000040455559</a></li><li><a href="https://gw.alipayobjects.com/os/bmw-prod/2cb0c283-5f24-485e-b635-b6efac887eba.pdf" target="_blank" rel="noopener noreferrer">PDF下载</a></li></ul><p><a href="https://gw.alipayobjects.com/os/bmw-prod/2cb0c283-5f24-485e-b635-b6efac887eba.pdf" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="KCL云原生配置策略语言" src="/zh-CN/assets/images/talk-cover-7bff56b2738955e27cf16a5ebb1a4506.png" width="1820" height="1366"></a></p>]]></content:encoded>
            <category>KCL</category>
        </item>
    </channel>
</rss>