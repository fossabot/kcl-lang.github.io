<!doctype html>
<html lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="KCL programming language. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="KCL programming language. Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="KCL programming language." href="/zh-CN/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">One post tagged with &quot;Compiler&quot; | KCL programming language.</title><meta data-rh="true" property="og:title" content="One post tagged with &quot;Compiler&quot; | KCL programming language."><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kcl-lang.github.io/zh-CN/blog/tags/compiler"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/zh-CN/img/kcl-logo.jpg"><link data-rh="true" rel="canonical" href="https://kcl-lang.github.io/zh-CN/blog/tags/compiler"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/blog/tags/compiler" hreflang="en"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/zh-CN/blog/tags/compiler" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kcl-lang.github.io/blog/tags/compiler" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RE5E6BQUZV-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh-CN/assets/css/styles.f544af73.css">
<link rel="preload" href="/zh-CN/assets/js/runtime~main.87b5a8b1.js" as="script">
<link rel="preload" href="/zh-CN/assets/js/main.9caddded.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" role="banner"><div class="announcementBarPlaceholder_NC_W"></div><div class="announcementBarContent_KsVm">⭐️ If you like KCL, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/KusionStack/KCLVM">Github</a></div><button type="button" class="clean-btn close announcementBarClose_FG1z" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="/zh-CN/img/kcl-logo.jpg" alt="KCL Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/zh-CN/img/kcl-logo.jpg" alt="KCL Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title"></b></a><a class="navbar__item navbar__link" docid="intro/kcl-intro" href="/zh-CN/docs/user_docs/getting-started/">使用文档</a><a class="navbar__item navbar__link" href="/zh-CN/docs/reference/lang/tour">参考手册</a><a class="navbar__item navbar__link" href="/zh-CN/docs/tools/cli/">工具</a><a href="http://39.106.40.108/-/play/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" sidebarid="playground"><span>游乐场<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/KusionStack/examples" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" sidebarid="examples"><span>样例<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/zh-CN/docs/community/intro/">社区</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-CN/blog">博客</a><a class="navbar__item navbar__link" href="/zh-CN/docs/events/2022/kcl_paper">事件</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/zh-CN/docs/events/2022/kcl_paper">0.4.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-CN/docs/next/events/2022/kcl_paper">Next</a></li><li><a class="dropdown__link" href="/zh-CN/docs/events/2022/kcl_paper">0.4.4</a></li><li><a class="dropdown__link" href="/zh-CN/docs/0.4.3/events/2022/kcl_paper">0.4.3</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>中文（中国）</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/compiler" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh-CN/blog/tags/compiler" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文（中国）</a></li><li><a href="https://github.com/KusionStack/kcl-lang.io/issues/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="searchBox_kyqE"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022-kcl-osdt-meeting">OSDT 2022 会议 KCL 介绍内容</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022-kcl-0.4.4-release-blog">KCL v0.4.4 发布日志</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022-kcl-rewrite-with-rust">性能提升 40 倍！我们用 Rust 重写了自己的项目</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022-kcl-setta-meeting">SETTA 2022 会议 KCL 介绍内容</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022-declarative-config-overview">声明式配置技术概述</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;Compiler&quot;</h1><a href="/zh-CN/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/2022-kcl-rewrite-with-rust">性能提升 40 倍！我们用 Rust 重写了自己的项目</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-11-29T00:00:00.000Z" itemprop="datePublished">2022年11月29日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">徐鹏飞</span></div><small class="avatar__subtitle" itemprop="description">KCL 团队成员</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="前言">前言<a class="hash-link" href="#前言" title="Direct link to heading">​</a></h2><p>Rust 已经悄然成为了最受欢迎的编程语言之一。作为一门新兴底层系统语言，Rust 拥有着内存安全性机制、接近于 C/C++ 语言的性能优势、出色的开发者社区和体验出色的文档、工具链和IDE 等诸多特点。本文将介绍笔者使用 Rust 重写项目并逐步落地生产环境的过程，以及在重写过程选择 Rust 的原因、遇到的问题以及使用 Rust 重写带来的成果。</p><p>我们目前正在使用 Rust 开发的项目叫做 <a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">KCL</a>，目前全部实现代码已经在 Github 上开源。KCL 是一个基于约束的记录及函数领域编程语言，致力于通过成熟的编程语言技术和实践来改进特领域如云原生 kubernetes 领域的大量繁杂配置编写和安全策略校验等，致力于构建围绕配置的更好的模块化、扩展性和稳定性，更简单的逻辑编写，以及更快的自动化集成和良好的生态延展性。更具体的 KCL 使用场景请访问 <a href="https://kcl-lang.github.io/" target="_blank" rel="noopener noreferrer">KCL 网站</a>，本文中不再过多赘述。</p><p>KCL 之前是使用 Python 编写的，出于用户使用体验、性能和稳定性的考虑，决定用 Rust 语言进行重写，并获得了以下好处：</p><ul><li>更少的 Bug，源于 Rust 强大的编译检查和错误处理方式</li><li>语言端到端编译执行性能提升了 66%</li><li>语言前端解析器性能提升了 20 倍</li><li>语言中端语义分析器性能提升了 40 倍</li><li>语言编译器编译过程平均内存使用量变为原来 Python 版本的一半</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="我们遇到了什么问题">我们遇到了什么问题<a class="hash-link" href="#我们遇到了什么问题" title="Direct link to heading">​</a></h2><p>就像社区中同类型项目 <a href="https://github.com/denoland/deno" target="_blank" rel="noopener noreferrer">deno</a>, <a href="https://github.com/swc-project/swc" target="_blank" rel="noopener noreferrer">swc</a>, <a href="https://github.com/vercel/turbo" target="_blank" rel="noopener noreferrer">turbopack</a>, <a href="https://github.com/rust-lang/rust" target="_blank" rel="noopener noreferrer">rustc</a> 等编译器、构建系统或者运行时在技术上使用 Rust 做的事情类似，我们使用 Rust 完整构建了编译器的前中端和运行时，取得了一定的阶段性成果，但是我们大约在一年前并不是这个样子的。</p><p>一年前，我们使用 Python 语言构建了整个 KCL 语言编译器的实现，虽然在一开始的时候运行良好，Python 简单易上手，生态丰富，团队的研发效率也很高，但是随着代码库的扩张和工程师人数的增加，代码维护起来愈加困难，尽管我们在项目中强制编写 Python 类型注解，采用更严格的 lint 工具，代码测试行覆盖率也达到了 90% 以上，但是仍然会出现很多诸如 Python None 空对象，属性未找到等运行时才会出现错误，并且重构 Python 代码时也需要小心翼翼，反应到 KCL 语言上就是一个接一个的 bug, 严重影响用户使用体验。</p><p>此外，当 KCL 使用对象是广大开发者用户时，编程语言或者说编译器内部实现出现任何错误都是不可容忍的，这些也给我们的用户使用体验带来了一系列问题，使用 Python 编写的程序启动速度较慢，性能无法满足自动化系统在线编译和执行的效率诉求，因为在我们的场景中，用户修改 KCL 代码后需要能很快的展示编译结果，显然使用 Python 编写的编译器并不能很好地满足使用需求。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="为什么选择-rust">为什么选择 Rust<a class="hash-link" href="#为什么选择-rust" title="Direct link to heading">​</a></h2><p>笔者所在团队基于如下原因选择了 Rust</p><ul><li>使用 Go, Python, Rust 三种语言实现了简单的编程语言栈式虚拟机并作了性能对比，Go 和 Rust 在这个场景下性能接近，Python 有较大性能差距，综合考虑下采用了 Rust，具体三种语言实现的栈式虚拟机代码细节在 <a href="https://github.com/Peefy/StackMachine" target="_blank" rel="noopener noreferrer">https://github.com/Peefy/StackMachine</a>，感兴趣的同学可以前往浏览</li><li>越来越多的编程语言的编译器或运行时特别是前端基础设施项目采用 Rust 编写或重构，此外基础设施层，数据库、搜索引擎、网络设施、云原生、UI 层和嵌入式等领域都有 Rust 的出现，至少在编程语言领域实现方面经过了可行性和稳定性验证</li><li>考虑到后续的项目发展会涉及区块链和智能合约方向，而社区中大量的区块链和智能合约项目采用 Rust 编写</li><li>通过 Rust 获得更好的性能和稳定性，让系统更容易维护、更加健壮的同时，可以通过 FFI 暴露 C API 供多语言使用和扩展，方便生态扩展与集成</li><li>Rust 对 WASM 的支持比较友好，社区中大量 WASM 生态是由 Rust 构建，KCL 语言和编译器可以借助 Rust 编译到 WASM 并在浏览器中运行</li></ul><p>基于以上原因综合考虑选择了 Rust 而不是 Go，整个重写过程下来发现 Rust 综合素质确实过硬（第一梯队的性能，足够的抽象程度），虽然在一些语言特性特别是生命周期等上手成本有一些，生态上还不够丰富，总之编程语言可以做的事情，Rust 均可以做，具体可能还是要根据具体的场景和问题来做选择。同时如果想要使用好 Rust, 还需要深入理解内存、堆栈、引用、变量作用域等这些其它高级语言往往不会深入接触的内容。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="使用-rust-过程中遇到了哪些困难">使用 Rust 过程中遇到了哪些困难<a class="hash-link" href="#使用-rust-过程中遇到了哪些困难" title="Direct link to heading">​</a></h2><p>虽然决定了使用 Rust 重写整个 KCL 项目，其实团队成员大部分成员是没有使用 Rust 编写一定代码体量项目的经验，包括笔者个人自己也仅仅学习过 <a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">《The Rust Programming Language》</a> 中的部分内容，依稀记得学习到 <code>Rc</code> 和 <code>RefCell</code> 等智能指针内容就放弃了，那时没想到 Rust 中还能有与 C++ 中类似的东西。</p><p>使用 Rust 前预估的风险主要是 Rust 语言接触和学习的成本，这个确实在各种 Rust 的文章博客中均有提到，因为 KCL 项目整体架构并未发生太大变化，只是部分模块设计和代码编写针对 Rust 作了优化，因此整个重写是在边学边实践中进行。确实在刚开始使用 Rust 编写整个项目的时候花费在知识查询、编译排错的时间还是很多的，不过随着项目的进行渐入佳境，笔者个人经验使用 Rust 遇到的困难主要是心智转换和开发效率两方面:</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="心智转换">心智转换<a class="hash-link" href="#心智转换" title="Direct link to heading">​</a></h3><p>首先 Rust 的语法语义很好地吸收和融合了函数式编程中类型系统相关的概念，比如抽象代数类型 ADT 等，并且 Rust 中并无“继承”等相关概念，如果不能很好地理解甚至连其他语言中稀松平常的结构定义在 Rust 中可能都需要花费不少时间，比如如下的 Python 代码可能在 Rust 中的定义是这个样子的。</p><ul><li>Python</li></ul><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> dataclasses </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> dataclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLObject</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@dataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLIntObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KCLObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@dataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KCLFloatObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KCLObject</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>Rust</li></ul><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">enum KCLObject {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Int(u64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Float(f64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>当然更多的时间是在与 Rust 编译器本身的报错作斗争，Rust 编译器会经常使开发人员&quot;碰壁&quot;，比如借用检查报错等，特别是对于编译器来讲，它处理的核心结构是抽象语法树 AST，这是一个递归和嵌套的树结构，在 Rust 中有时很难兼顾变量可变性与借用检查的关系，就如 KCL 编译器作用域 <code>Scope</code> 的结构定义结构那样，对于存在循环引用的场景，用于需要显示意识到数据的相互依赖关系，而大量使用 <code>Rc</code>, <code>RefCell</code> 和 <code>Weak</code> 等 Rust 中常用的智能指针结构。</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/// A Scope maintains a set of objects and links to its containing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// (parent) and contained (children) scopes. Objects may be inserted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// and looked up by name. The zero value for Scope is a ready-to-use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// empty scope.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct Scope {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The parent scope.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub parent: Option&lt;Weak&lt;RefCell&lt;Scope&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The child scope list.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub children: Vec&lt;Rc&lt;RefCell&lt;Scope&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope object mapping with its name.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub elems: IndexMap&lt;String, Rc&lt;RefCell&lt;ScopeObject&gt;&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope start position.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub start: Position,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope end position.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub end: Position,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The scope kind.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub kind: ScopeKind,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="开发效率">开发效率<a class="hash-link" href="#开发效率" title="Direct link to heading">​</a></h3><p>Rust 的开发效率可以用先抑后扬来形容。在刚开始上手写项目时，如果团队成员没有接触过函数式编程相关概念以及相关的编程习惯，开发速度将显著慢于 Python、Go 和 Java 等语言，不过一旦开始熟悉 Rust 标准库常用的方法、最佳实践以及常见 Rust 编译器报错修改，开发效率将大幅提升，并且原生就能写出高质量、安全、高效的代码。</p><p>比如笔者个人当初遇到一个如下代码所示的与生命周期错误前前后后排查了很久的时间才发现原来是忘记标注生命参数导致生命周期不匹配。此外 Rust 的生命周期与类型系统、作用域、所有权、借用检查等概念耦合在一起，导致了较高的理解成本和复杂度，且报错信息往往不像类型错误那么明显，生命周期不匹配错误报错信息有时也略显呆板，可能会导致较高的排错成本，当然熟悉相关概念写多了之后效率会提高不少。</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">struct Data&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b: &amp;&#x27;a u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// func1 和 func2 一个省略了生命周期参数，一个没有省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 对于 func2 的生命周期会由编译器缺省推导为 &#x27;_，可能导致生命周期不匹配错误</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;&#x27;a&gt; Data&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn func1(&amp;self) -&gt; Data&lt;&#x27;a&gt; {Data { b: &amp;0 }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn func2(&amp;self) -&gt; Data {Data { b: &amp;0 }}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="使用-rust-重写收益比">使用 Rust 重写收益比<a class="hash-link" href="#使用-rust-重写收益比" title="Direct link to heading">​</a></h2><p>经过团队几个人花费几个月时间使用 Rust 完全重写并稳定落地生产环境几个月后，回顾整个过程感觉这件事情的收获非常大，从技术角度层面来看，重写的过程不仅仅锻炼了快速学习一门新的编程语言、编程知识并将其付诸实践，并且整个重写过程让我们又反思了 KCL 编译器中设计不合理的部分并进行修改，对一个编程语言而言，这是一个长周期的项目，我们收获的是编译器系统更加稳定、安全，且代码清晰，bug 更少、性能更好的技术产品服务于用户，虽然没有全部模块得到高达 40 倍的性能，因为部分模块如 KCL 运行时的性能瓶颈在于内存深拷贝操作，但笔者个人认为仍然是值得的。且当 Rust 使用时间到达一定时长后，心智和开发效率不再是限制因素，就像学车那样，拿到驾照后更多是上路实践和总结。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="结语">结语<a class="hash-link" href="#结语" title="Direct link to heading">​</a></h2><p>笔者个人觉得使用 Rust 重写项目后最重要的是不是我学会了一门新的编程语言，也不是 Rust 很流行很火因此我们在项目中采用一下，或者使用 Rust 编写了多少炫技的代码，是真真正正地使得语言和编译器本身更加稳定，能够在生产环境平稳落地并长期使用，启动速度和自动化效率不再受困扰，性能优于社区其他同类型领域编程语言，使我们语言和工具的用户感受到体验提升，这些都得益于 Rust 的无 GC、高性能、更好的错误处理内存管理、零抽象等特性。总之作为用户，他们才是最大的受益者。</p><p>最后，如果大家喜欢 KCL 语言这个项目，或想使用体验 KCL 用于自己的场景，或想使用 Rust 语言参与一个开源项目，欢迎大家访问 <a href="https://github.com/KusionStack/community" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/community</a> 加入我们的社区一起参与讨论和共建 👏👏👏。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="参考">参考<a class="hash-link" href="#参考" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer">https://github.com/KusionStack/KCLVM</a></li><li><a href="https://github.com/Peefy/StackMachine" target="_blank" rel="noopener noreferrer">https://github.com/Peefy/StackMachine</a></li><li><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">https://doc.rust-lang.org/book/</a></li><li><a href="https://github.com/sunface/rust-course" target="_blank" rel="noopener noreferrer">https://github.com/sunface/rust-course</a></li><li><a href="https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/" target="_blank" rel="noopener noreferrer">https://www.influxdata.com/blog/rust-can-be-difficult-to-learn-and-frustrating-but-its-also-the-most-exciting-thing-in-software-development-in-a-long-time/</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/kcl">KCL</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/rust">Rust</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/performance">Performance</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/programming-language">Programming Language</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/compiler">Compiler</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 性能提升 40 倍！我们用 Rust 重写了自己的项目" href="/zh-CN/blog/2022-kcl-rewrite-with-rust"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/user_docs/getting-started/intro">简介</a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/blog">博客</a></li><li class="footer__item"><a href="https://github.com/KusionStack/KCLVM" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://join.slack.com/t/KusionStack/shared_invite/zt-19lqcc3a9-_kTNwagaT5qwBE~my5Lnxg" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.antgroup.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/zh-CN/img/oss_logo.svg" alt="AntGroup Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo" width="160" height="51"><img src="/zh-CN/img/oss_logo.svg" alt="AntGroup Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo" width="160" height="51"></a></div><div class="footer__copyright">版权 © 2022 KCL Authors</div></div></div></footer></div>
<script src="/zh-CN/assets/js/runtime~main.87b5a8b1.js"></script>
<script src="/zh-CN/assets/js/main.9caddded.js"></script>
</body>
</html>